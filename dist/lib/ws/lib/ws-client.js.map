{"version":3,"file":"ws-client.js","sourceRoot":"","sources":["../../../../src/lib/ws/lib/ws-client.ts"],"names":[],"mappings":";;;;;AAAA,yCAAgH;AAIhH,+CAA8D;AAC9D,0DAAkC;AAGlC,mCAA8C;AAgB9C,MAAqB,cAAe,SAAS,kBAAkC;IASpD;IAGT;IAXP,UAAU,CAA6B;IACpC,YAAY,CAAwB;IACpC,SAAS,CAAyB;IAClC,eAAe,CAAS;IAElC,YACI,KAAa,EACb,SAAoB,EACD,eAAgC,EACnD,gBAAwC,EACxC,gBAAqC,EAC3B,0BAAkC,KAAK;QAEjD,KAAK,EAAE,CAAC;QALW,oBAAe,GAAf,eAAe,CAAiB;QAGzC,4BAAuB,GAAvB,uBAAuB,CAAgB;QAIjD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,eAAe,GAAG,GAAG,KAAK,IAAI,IAAI,eAAe,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,gBAAM,CAAC,yCAAyC,EAAE,CAAC;QAClI,IAAI,CAAC,SAAS,GAAG,EAAE,MAAM,EAAE,SAAS,CAAC,eAAe,EAAE,EAAE,GAAG,CAAC,gBAAgB,IAAI,EAAE,CAAC,EAAE,CAAC;QACtF,IAAI,CAAC,EAAE,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC9C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,EAAE,WAAW,gBAAM,CAAC,eAAe,EAAE,EAAE,IAAI,CAAC,SAAS,EAAE,gBAAgB,CAAC,CAAC;IAClH,CAAC;IAES,SAAS,CAAC,YAAiC;QACjD,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,IAAI,CAAC,UAAU,GAAG,YAAY,CAAC;QAC/B,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,aAAa,EAAE,EAAE,IAAI,CAAC,uBAAuB,CAAC,CAAC;QAC1F,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACzD,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAC9D,CAAC;IAED;;;;OAIG;IACI,SAAS,CAAC,IAAgB;QAC7B,IAAI,IAAI,CAAC,UAAU,EAAE;YACjB,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YAC7C,OAAO,IAAI,CAAC;SACf;QACD,OAAO,KAAK,CAAC;IACjB,CAAC;IAES,YAAY;QAClB,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACjC,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IACvB,CAAC;IAED;;;;OAIG;IACO,KAAK,CAAC,SAAS,CAAC,OAAyB;QAE/C,sBAAsB;QACtB,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,OAAO,CAAC,CAAC;QAEpC,yDAAyD;QACzD,IAAI,OAAO,CAAC,IAAI,KAAK,QAAQ,EAAE;YAC3B,OAAO,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,OAAO,CAAC,CAAC;SAChD;QAED,uCAAuC;QACvC,IAAI;YACA,MAAM,gBAAgB,GAA4B,MAAM,IAAA,uCAA2B,EAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YAExG,qCAAqC;YACrC,IAAI,gBAAgB,CAAC,EAAE,IAAI,IAAI,EAAE;gBAC7B,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAC;aACrC;YAED,uDAAuD;YACvD,IAAI,gBAAgB,CAAC,uBAAuB,EAAE;gBAC1C,IAAI,CAAC,IAAI,CAAC,yBAAyB,EAAE,gBAAgB,CAAC,uBAAuB,CAAC,CAAC;aAClF;SACJ;QAAC,OAAO,GAAG,EAAE;YACV,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,GAAG,CAAC,CAAC;SAC3C;IAEL,CAAC;IAED;;OAEG;IACO,aAAa;QACnB,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC,CAAC;IACnD,CAAC;IAED;;;OAGG;IACO,OAAO,CAAC,EAAU;QACxB,MAAM,UAAU,GAAiB,2BAAmB,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,CAAC;QACjF,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;IAChE,CAAC;IAED;;OAEG;IACI,KAAK;QAER,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC3B,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,OAAO,EAAE,CAAC,CAAC;YAEpC,2BAA2B;YAC3B,IAAI,IAAI,CAAC,UAAU,EAAE;gBACjB,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;aAC/B;YACD,gCAAgC;iBAC3B;gBACD,OAAO,EAAE,CAAC;aACb;QAEL,CAAC,CAAC,CAAC;IAEP,CAAC;CACJ;AA1HD,iCA0HC","sourcesContent":["import { client as WebSocket, connection as WebSocketConnection, Message as WebSocketMessage } from 'websocket';\r\nimport * as http from 'node:http';\r\nimport { BinaryWriter } from '@bufbuild/protobuf/wire';\r\nimport { DecodedWebcastPushFrame, WebSocketParams } from '@/types/client';\r\nimport { deserializeWebSocketMessage } from '@/lib/utilities';\r\nimport Config from '@/lib/config';\r\nimport TypedEventEmitter from 'typed-emitter';\r\nimport CookieJar from '@/lib/web/lib/cookie-jar';\r\nimport { WebSocketAckMessage } from '@/types';\r\n\r\n\r\ntype EventMap = {\r\n    connect: (connection: WebSocketConnection) => void;\r\n    close: () => void;\r\n    messageDecodingFailed: (error: Error) => void;\r\n    unknownResponse: (message: WebSocketMessage) => void;\r\n    protoMessageFetchResult: (response: any) => void;\r\n    webSocketData: (data: Uint8Array) => void;\r\n};\r\n\r\ntype TypedWebSocket = WebSocket & TypedEventEmitter<EventMap>;\r\ntype WebSocketConstructor = new () => TypedWebSocket;\r\n\r\n\r\nexport default class TikTokWsClient extends (WebSocket as WebSocketConstructor) {\r\n    public connection: WebSocketConnection | null;\r\n    protected pingInterval: NodeJS.Timeout | null;\r\n    protected wsHeaders: Record<string, string>;\r\n    protected wsUrlWithParams: string;\r\n\r\n    constructor(\r\n        wsUrl: string,\r\n        cookieJar: CookieJar,\r\n        protected readonly webSocketParams: WebSocketParams,\r\n        webSocketHeaders: Record<string, string>,\r\n        webSocketOptions: http.RequestOptions,\r\n        protected webSocketPingIntervalMs: number = 10000\r\n    ) {\r\n        super();\r\n\r\n        this.pingInterval = null;\r\n        this.connection = null;\r\n        this.wsUrlWithParams = `${wsUrl}?${new URLSearchParams(this.webSocketParams)}${Config.DEFAULT_WS_CLIENT_PARAMS_APPEND_PARAMETER}`;\r\n        this.wsHeaders = { Cookie: cookieJar.getCookieString(), ...(webSocketHeaders || {}) };\r\n        this.on('connect', this.onConnect.bind(this));\r\n        this.connect(this.wsUrlWithParams, '', `https://${Config.TIKTOK_HOST_WEB}`, this.wsHeaders, webSocketOptions);\r\n    }\r\n\r\n    protected onConnect(wsConnection: WebSocketConnection) {\r\n        this.sendHeartbeat();\r\n        this.connection = wsConnection;\r\n        this.pingInterval = setInterval(() => this.sendHeartbeat(), this.webSocketPingIntervalMs);\r\n        this.connection.on('message', this.onMessage.bind(this));\r\n        this.connection.on('close', this.onDisconnect.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Send a message to the WebSocket server\r\n     * @param data The message to send\r\n     * @returns True if the message was sent, false otherwise\r\n     */\r\n    public sendBytes(data: Uint8Array): boolean {\r\n        if (this.connection) {\r\n            this.connection.sendBytes(Buffer.from(data));\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    protected onDisconnect() {\r\n        clearInterval(this.pingInterval);\r\n        this.pingInterval = null;\r\n        this.connection = null;\r\n        this.emit('close');\r\n    }\r\n\r\n    /**\r\n     * Handle incoming messages\r\n     * @param message The incoming WebSocket message\r\n     * @protected\r\n     */\r\n    protected async onMessage(message: WebSocketMessage) {\r\n\r\n        // Emit WebSocket data\r\n        this.emit('webSocketData', message);\r\n\r\n        // If the message is not binary, emit an unknown response\r\n        if (message.type !== 'binary') {\r\n            return this.emit('unknownResponse', message);\r\n        }\r\n\r\n        //  If the message is binary, decode it\r\n        try {\r\n            const decodedContainer: DecodedWebcastPushFrame = await deserializeWebSocketMessage(message.binaryData);\r\n\r\n            // Always send an ACK for the message\r\n            if (decodedContainer.id != null) {\r\n                this.sendAck(decodedContainer.id);\r\n            }\r\n\r\n            // If the message is a protoMessageFetchResult, emit it\r\n            if (decodedContainer.protoMessageFetchResult) {\r\n                this.emit('protoMessageFetchResult', decodedContainer.protoMessageFetchResult);\r\n            }\r\n        } catch (err) {\r\n            this.emit('messageDecodingFailed', err);\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * Static Keep-Alive ping\r\n     */\r\n    protected sendHeartbeat() {\r\n        this.sendBytes(Buffer.from('3A026862', 'hex'));\r\n    }\r\n\r\n    /**\r\n     * Message Acknowledgement\r\n     * @param id The message id to acknowledge\r\n     */\r\n    protected sendAck(id: string): void {\r\n        const ackMessage: BinaryWriter = WebSocketAckMessage.encode({ type: 'ack', id });\r\n        this.connection.sendBytes(Buffer.from(ackMessage.finish()));\r\n    }\r\n\r\n    /**\r\n     * Close the WebSocket connection\r\n     */\r\n    public close(): Promise<void> {\r\n\r\n        return new Promise((resolve) => {\r\n            this.once('close', () => resolve());\r\n\r\n            // If connected, disconnect\r\n            if (this.connection) {\r\n                this.connection.close(1000);\r\n            }\r\n            // Otherwise immediately resolve\r\n            else {\r\n                resolve();\r\n            }\r\n\r\n        });\r\n\r\n    }\r\n}\r\n\r\n"]}