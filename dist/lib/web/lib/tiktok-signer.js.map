{"version":3,"file":"tiktok-signer.js","sourceRoot":"","sources":["../../../../src/lib/web/lib/tiktok-signer.ts"],"names":[],"mappings":";;;;;;AACA,2CAAkF;AAClF,+EAAkH;AAElH,+BAAmC;AAGnC;;GAEG;AACH,MAAa,WAAY,SAAQ,uBAAoB;IAEjD,YAAY,SAAuC,EAAE;QACjD,KAAK,CAAC,EAAE,GAAG,gBAAU,EAAE,GAAG,MAAM,EAAE,CAAC,CAAC;IACxC,CAAC;IAED;;;;;;;;OAQG;IACI,KAAK,CAAC,WAAW,CACpB,GAAiB,EACjB,MAAoC,EACpC,SAAiB,EACjB,SAAkB,EAClB,WAAoB;QAEpB,MAAM,gBAAgB,GAAG,CAAC,SAAS,EAAE,UAAU,EAAE,SAAS,CAAC,CAAC;QAC5D,IAAI,QAAQ,GAAG,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;QAE9D,KAAK,MAAM,KAAK,IAAI,gBAAgB,EAAE;YAClC,QAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,IAAI,MAAM,CAAC,SAAS,KAAK,QAAQ,EAAE,GAAG,CAAC,EAAE,IAAI,CAAC,CAAC;YAC3E,QAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;SAC5C;QAED,IAAI,SAAS,IAAI,CAAC,WAAW,EAAE;YAC3B,MAAM,IAAI,KAAK,CACX,qDAAqD,CACxD,CAAC;SACL;QAED,eAAe;QACf,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,cAAc,CAC9C;YACI,GAAG,EAAE,QAAQ;YACb,MAAM,EAAE,MAAM;YACd,SAAS,EAAE,SAAS;YACpB,SAAS,EAAE,SAAS;YACpB,WAAW,EAAE,WAAW;SAC3B,CACJ,CAAC;QAEF,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE;YACzB,MAAM,IAAI,4BAAmB,CACzB,0EAA0E,EAC1E,QAAQ,CAAC,IAAI,CAAC,OAAO,EACrB,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,CAChC,CAAC;SACL;QAED,IAAI,CAAC,QAAQ,CAAC,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,IAAI,EAAE,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE;YAC/E,MAAM,IAAI,oCAA2B,CACjC,6DAA6D,CAChE,CAAC;SACL;QAED,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE;YACzB,MAAM,IAAI,oCAA2B,CACjC,6BAA6B,QAAQ,EAAE,IAAI,EAAE,OAAO,IAAI,eAAe,EAAE,CAC5E,CAAC;SACL;QAED,OAAO,QAAQ,CAAC,IAAI,CAAC;IACzB,CAAC;CACJ;AArED,kCAqEC","sourcesContent":["import { URL } from 'url';\r\nimport { PremiumFeatureError, SignatureMissingTokensError } from '@/types/errors';\r\nimport EulerStreamApiClient, { ClientConfiguration, SignWebcastUrl200Response } from '@eulerstream/euler-api-sdk';\r\nimport { ISignTikTokUrlBodyMethodEnum } from '@eulerstream/euler-api-sdk/dist/sdk/api';\r\nimport { SignConfig } from '@/lib';\r\n\r\n\r\n/**\r\n * TikTok Signer class\r\n */\r\nexport class EulerSigner extends EulerStreamApiClient {\r\n\r\n    constructor(config: Partial<ClientConfiguration> = {}) {\r\n        super({ ...SignConfig, ...config });\r\n    }\r\n\r\n    /**\r\n     * Sign a URL using the TikTok signature provider\r\n     *\r\n     * @param url The URL to sign\r\n     * @param method The HTTP method to use (GET, POST, etc.)\r\n     * @param userAgent The user agent to sign with\r\n     * @param sessionId The session ID to use (optional)\r\n     * @param ttTargetIdc The target IDC to use (optional)\r\n     */\r\n    public async webcastSign(\r\n        url: string | URL,\r\n        method: ISignTikTokUrlBodyMethodEnum,\r\n        userAgent: string,\r\n        sessionId?: string,\r\n        ttTargetIdc?: string\r\n    ): Promise<SignWebcastUrl200Response> {\r\n        const mustRemoveParams = ['X-Bogus', 'X-Gnarly', 'msToken'];\r\n        let cleanUrl = typeof url === 'string' ? url : url.toString();\r\n\r\n        for (const param of mustRemoveParams) {\r\n            cleanUrl = cleanUrl.replace(new RegExp(`([&?])${param}=[^&]*`, 'g'), '$1');\r\n            cleanUrl = cleanUrl.replace(/[&?]$/, '');\r\n        }\r\n\r\n        if (sessionId && !ttTargetIdc) {\r\n            throw new Error(\r\n                'ttTargetIdc must be set when sessionId is provided.'\r\n            );\r\n        }\r\n\r\n        // Sign the URL\r\n        const response = await this.webcast.signWebcastUrl(\r\n            {\r\n                url: cleanUrl,\r\n                method: method,\r\n                userAgent: userAgent,\r\n                sessionId: sessionId,\r\n                ttTargetIdc: ttTargetIdc\r\n            }\r\n        );\r\n\r\n        if (response.status === 403) {\r\n            throw new PremiumFeatureError(\r\n                'You do not have permission from the signature provider to sign this URL.',\r\n                response.data.message,\r\n                JSON.stringify(response.data)\r\n            );\r\n        }\r\n\r\n        if (!response.data || Object.keys(response.data.response.tokens || {}).length < 1) {\r\n            throw new SignatureMissingTokensError(\r\n                'Failed to sign a request due to missing tokens in response!'\r\n            );\r\n        }\r\n\r\n        if (response.status !== 200) {\r\n            throw new SignatureMissingTokensError(\r\n                `Failed to sign a request: ${response?.data?.message || 'Unknown error'}`\r\n            );\r\n        }\r\n\r\n        return response.data;\r\n    }\r\n}\r\n"]}