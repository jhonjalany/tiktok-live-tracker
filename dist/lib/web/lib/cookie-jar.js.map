{"version":3,"file":"cookie-jar.js","sourceRoot":"","sources":["../../../../src/lib/web/lib/cookie-jar.ts"],"names":[],"mappings":"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","sourcesContent":["import { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios';\r\nimport Config from '@/lib/config';\r\n\r\n/**\r\n * Custom cookie jar for axios\r\n * Because axios-cookiejar-support does not work as expected when using proxy agents\r\n * https://github.com/zerodytrash/TikTok-Livestream-Chat-Connector/issues/18\r\n */\r\nexport default class CookieJar {\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * @param axiosInstance The axios instance to attach the cookie jar to\r\n     * @param cookies The initial cookies to set\r\n     */\r\n    constructor(\r\n        public readonly axiosInstance: AxiosInstance,\r\n        public readonly cookies: Record<string, string> = Config.DEFAULT_HTTP_CLIENT_COOKIES\r\n    ) {\r\n        // Intercept responses to store cookies\r\n        this.axiosInstance.interceptors.response.use((response) => {\r\n            this.readCookies(response);\r\n            return response;\r\n        });\r\n\r\n        // Intercept request to append cookies\r\n        this.axiosInstance.interceptors.request.use((request) => {\r\n            this.appendCookies(request);\r\n            return request;\r\n        });\r\n\r\n        // Return a proxy object to allow direct access to cookies\r\n        return new Proxy(\r\n            this,\r\n            {\r\n                get(target: CookieJar, p: string): any {\r\n                    if (p in target) {\r\n                        return target[p];\r\n                    } else {\r\n                        return target.cookies[p];\r\n                    }\r\n                },\r\n                set(target: CookieJar, p: string, value: any): boolean {\r\n                    if (value === null) {\r\n                        // Delete the cookie if the value is null\r\n                        delete target.cookies[p];\r\n                        return true;\r\n                    }\r\n\r\n                    if (p in target) {\r\n                        target[p] = value;\r\n                    } else {\r\n                        target.cookies[p] = value;\r\n                    }\r\n                    return true;\r\n                },\r\n                deleteProperty(target: CookieJar, p: string): boolean {\r\n                    delete target.cookies[p];\r\n                    return true;\r\n                }\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Set the session ID and tt-target-idc\r\n     *\r\n     * @param sessionId The session ID to set\r\n     * @param ttTargetIdc The tt-target-idc to set\r\n     */\r\n    public setSession(sessionId: string | null, ttTargetIdc: string | null) {\r\n\r\n        if (sessionId && !ttTargetIdc) {\r\n            throw new Error('tt-target-idc is required when sessionId is set');\r\n        }\r\n\r\n        // (1) Set the sid\r\n        this.cookies['sessionid'] = sessionId;\r\n        this.cookies['sessionid_ss'] = sessionId;\r\n        this.cookies['sid_tt'] = sessionId;\r\n        this.cookies['sid_guard'] = sessionId;\r\n\r\n        // (2) Set the IDC, basically, the account region. Must match the account's sid.\r\n        this.cookies['tt-target-idc'] = ttTargetIdc;\r\n    }\r\n\r\n    /**\r\n     * Get the tt-target-idc cookie\r\n     */\r\n    public get ttTargetIdc(): string | null {\r\n        return this.cookies['tt-target-idc'] || null;\r\n    }\r\n\r\n    /**\r\n     * Get the session ID\r\n     */\r\n    public get sessionId(): string | null {\r\n        return this.cookies['sessionid'] || this.cookies['sessionid_ss'] || this.cookies['sid_tt'] || this.cookies['sid_guard'] || null;\r\n    }\r\n\r\n    /**\r\n     * Read cookies from response headers\r\n     * @param response The axios response\r\n     */\r\n    public readCookies(response: AxiosResponse) {\r\n        const setCookieHeaders = response.headers['set-cookie'];\r\n        if (Array.isArray(setCookieHeaders)) {\r\n            // Multiple set-cookie headers\r\n            setCookieHeaders.forEach((setCookieHeader) => this.processSetCookieHeader(setCookieHeader));\r\n        } else if (typeof setCookieHeaders === 'string') {\r\n            // Single set-cookie header\r\n            this.processSetCookieHeader(setCookieHeaders);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Append cookies to request headers\r\n     * @param request The axios request\r\n     */\r\n    public appendCookies(request: AxiosRequestConfig) {\r\n        // We use the capitalized 'Cookie' header, because every browser does that\r\n        if (request.headers['cookie']) {\r\n            request.headers['Cookie'] = request.headers['cookie'];\r\n            delete request.headers['cookie'];\r\n        }\r\n\r\n        // Cookies already set by custom headers? => Append\r\n        const headerCookie = request.headers['Cookie'];\r\n        if (typeof headerCookie === 'string') {\r\n            Object.assign(this.cookies, this.parseCookie(headerCookie), this.cookies);\r\n        }\r\n\r\n        request.headers['Cookie'] = this.getCookieString();\r\n    }\r\n\r\n    /**\r\n     * Parse cookie string\r\n     * @param str The cookie string\r\n     */\r\n    public parseCookie(str: string): Record<string, string> {\r\n        const cookies: Record<string, string> = {};\r\n        if (!str) return cookies;\r\n\r\n        str.split('; ').forEach((v) => {\r\n            if (!v) return;\r\n            const parts = String(v).split('=');\r\n            const cookieName = decodeURIComponent(parts.shift());\r\n            cookies[cookieName] = parts.join('=');\r\n        });\r\n\r\n        return cookies;\r\n    }\r\n\r\n    /**\r\n     * Process a single set-cookie header\r\n     * @param setCookieHeader The set-cookie header\r\n     */\r\n    public processSetCookieHeader(setCookieHeader: string): void {\r\n        const nameValuePart = setCookieHeader.split(';')[0];\r\n        const parts = nameValuePart.split('=');\r\n        const cookieName = parts.shift();\r\n        const cookieValue = parts.join('=');\r\n\r\n        if (typeof cookieName === 'string' && cookieName !== '' && typeof cookieValue === 'string') {\r\n            this.cookies[decodeURIComponent(cookieName)] = cookieValue;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the cookie string\r\n     */\r\n    public getCookieString(): string {\r\n        let cookieParams = [];\r\n\r\n        for (const [cookieName, cookieValue] of Object.entries(this.cookies)) {\r\n            if (!cookieValue) continue;\r\n            cookieParams.push(cookieName + '=' + cookieValue);\r\n        }\r\n\r\n        return cookieParams.join('; ');\r\n    }\r\n\r\n}\r\n\r\n"]}